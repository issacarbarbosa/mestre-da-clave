<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- Esta meta tag √© crucial para evitar que o celular d√™ zoom autom√°tico e estrague o jogo -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestre da Clave V2.10 (Fix Colis√£o)</title>
    <style>
        /* Importa a fonte bonita do Google */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');
        
        /* Reset b√°sico para garantir tamanhos previs√≠veis */
        * { box-sizing: border-box; touch-action: manipulation; } 

        body {
            margin: 0; padding: 0;
            background-color: #2c3e50;
            font-family: 'Poppins', sans-serif;
            overflow: hidden; /* Impede a tela de rolar para baixo */
            width: 100vw; height: 100vh;
            color: #333; user-select: none; /* Impede selecionar texto */
            display: flex; flex-direction: column;
        }

        /* --- TRAVA DE ROTA√á√ÉO --- */
        /* S√≥ aparece se a orienta√ß√£o for 'portrait' (celular em p√©) */
        #rotate-message {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #main-wrapper { display: none !important; } /* Esconde o jogo se estiver em p√© */
        }

        /* --- LAYOUT PRINCIPAL --- */
        #main-wrapper { 
            flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; 
            background: radial-gradient(circle, #fdf6e3 0%, #f0e4d0 100%);
        }

        /* √Årea onde as notas correm */
        #game-area { 
            flex: 1; /* Ocupa todo o espa√ßo que sobrar */
            position: relative; width: 100%; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* Placar (HUD) flutuando sobre o canvas */
        #hud { position: absolute; top: 5px; left: 10px; right: 10px; display: flex; justify-content: space-between; pointer-events: none; z-index: 5; }
        .hud-pill { background: rgba(255,255,255,0.9); padding: 4px 12px; border-radius: 15px; font-weight: bold; font-size: 0.9rem; color: #2c3e50; border: 1px solid #2c3e50; }

        /* --- BOT√ïES E CONTROLES --- */
        #controls-container {
            flex: 0 0 auto; /* N√£o deixa encolher */
            height: auto; 
            background: #34495e;
            display: flex; flex-direction: column; justify-content: center;
            padding: 5px 5px 10px 5px; gap: 5px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 10;
        }

        /* Fileira de cima (Sustenido e Bemol) */
        #modifiers-row { display: flex; justify-content: center; gap: 15px; height: 35px; }
        .mod-btn {
            width: 60px; height: 100%; background: #95a5a6; color: white;
            border: 2px solid transparent; border-radius: 6px;
            font-size: 1.2rem; line-height: 1; font-weight: bold;
            cursor: pointer; transition: all 0.1s; display: flex; align-items: center; justify-content: center;
        }
        /* Estilo quando o bot√£o de acidente est√° ATIVO */
        .mod-btn.active-sharp { background: #e74c3c; border-color: white; box-shadow: 0 0 8px white; }
        .mod-btn.active-flat { background: #3498db; border-color: white; box-shadow: 0 0 8px white; }

        /* Fileira de baixo (Notas Naturais) */
        #notes-row { display: flex; gap: 4px; height: 45px; }
        .note-btn {
            flex: 1; background: linear-gradient(to bottom, #ecf0f1, #bdc3c7);
            border: none; border-radius: 4px; font-family: 'Poppins', sans-serif; font-weight: bold; font-size: 0.9rem;
            color: #2c3e50; cursor: pointer; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2);
        }
        .note-btn:active { background: #95a5a6; transform: translateY(2px); }
        /* Cores sutis na base das teclas */
        .btn-do { border-bottom: 3px solid #e74c3c; } .btn-re { border-bottom: 3px solid #e67e22; }
        .btn-mi { border-bottom: 3px solid #f1c40f; } .btn-fa { border-bottom: 3px solid #2ecc71; }
        .btn-sol { border-bottom: 3px solid #3498db; } .btn-la { border-bottom: 3px solid #9b59b6; }
        .btn-si { border-bottom: 3px solid #34495e; }

        /* --- TELAS DE IN√çCIO E FIM (OVERLAY) --- */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; text-align: center; color: white;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 1.8rem; margin: 0 0 10px 0; color: #f1c40f; }
        p { font-size: 1rem; max-width: 80%; margin-bottom: 25px; color: #ecf0f1; }
        
        .btn-primary { 
            padding: 12px 40px; font-size: 1.2rem; background-color: #27ae60; 
            color: white; border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 4px 0 #1e8449; 
        }
        
        /* Texto flutuante ("Boa!", "Errou!") */
        .feedback { position: absolute; font-weight: 900; font-size: 2rem; animation: popUp 0.8s forwards; pointer-events: none; z-index: 50; text-shadow: 1px 1px 0 #fff; }
        @keyframes popUp { 0% { transform: scale(0.5) translateY(0); opacity: 0; } 100% { transform: scale(1) translateY(-60px); opacity: 0; } }
    </style>
</head>
<body>

    <!-- Mensagem se o usu√°rio estiver com celular em p√© -->
    <div id="rotate-message">
        <h1 style="font-size: 3rem;">‚Üª</h1>
        <h2>Gire o celular</h2>
    </div>

    <!-- Interface Principal -->
    <div id="main-wrapper">
        <div id="game-area">
            <canvas id="gameCanvas"></canvas>
            <div id="hud">
                <div class="hud-pill">Pontos: <span id="score">0</span></div>
                <div class="hud-pill">Vidas: <span id="lives">3</span></div>
            </div>
        </div>

        <div id="controls-container">
            <!-- Bot√µes de Acidente -->
            <div id="modifiers-row">
                <button id="btn-flat" class="mod-btn" onpointerdown="toggleModifier('flat')">‚ô≠</button>
                <button id="btn-sharp" class="mod-btn" onpointerdown="toggleModifier('sharp')">‚ôØ</button>
            </div>
            <!-- Bot√µes de Notas -->
            <div id="notes-row">
                <button class="note-btn btn-do" onpointerdown="inputNote('D√≥')">D√≥</button>
                <button class="note-btn btn-re" onpointerdown="inputNote('R√©')">R√©</button>
                <button class="note-btn btn-mi" onpointerdown="inputNote('Mi')">Mi</button>
                <button class="note-btn btn-fa" onpointerdown="inputNote('F√°')">F√°</button>
                <button class="note-btn btn-sol" onpointerdown="inputNote('Sol')">Sol</button>
                <button class="note-btn btn-la" onpointerdown="inputNote('L√°')">L√°</button>
                <button class="note-btn btn-si" onpointerdown="inputNote('Si')">Si</button>
            </div>
        </div>
    </div>

    <!-- Tela Inicial -->
    <div id="start-screen" class="overlay">
        <h1>Mestre da Clave V2.10</h1>
        <p>Ajuste Fino:<br>As notas agora somem ao sair da zona verde.</p>
        <button class="btn-primary" onclick="startGame()">JOGAR</button>
    </div>

    <!-- Tela de Game Over -->
    <div id="game-over-screen" class="overlay hidden">
        <h1 style="color: #e74c3c;">Fim de Jogo!</h1>
        <p>Pontua√ß√£o: <strong id="final-score" style="color:#f1c40f">0</strong></p>
        <button class="btn-primary" onclick="resetGame()">Tentar Novamente</button>
    </div>

    <script>
        // Configura√ß√£o Inicial do Canvas
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameArea = document.getElementById('game-area');

        // Vari√°veis de Estado (Mem√≥ria do Jogo)
        let gameState = 'MENU';
        let score = 0; 
        let lives = 3; 
        let gameSpeed = 3.0; // Velocidade inicial das notas
        let spawnTimer = 0; 
        let spawnInterval = 110; // Tempo entre notas (frames)
        let notes = []; 
        let animationId;
        
        let activeModifier = null; // Guarda se clicou em sustenido/bemol
        let staffCenterY, lineGap; // Posi√ß√£o Y da pauta e tamanho das linhas
        const hitZone = { start: 90, end: 320 }; // √Årea verde onde o clique vale

        // --- SISTEMA DE √ÅUDIO (Web Audio API) ---
        // Browsers precisam de intera√ß√£o do usu√°rio para tocar som, por isso iniciamos no 'startGame'
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playFeedback(type) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            // 'sine' = som suave (acerto), 'sawtooth' = som √°spero (erro)
            osc.type = type === 'hit' ? 'sine' : 'sawtooth';
            osc.frequency.setValueAtTime(type === 'hit' ? 880 : 150, audioCtx.currentTime);
            
            // Controle de volume (fade out r√°pido)
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        // Fun√ß√£o para ativar Tela Cheia no celular
        function enterFullScreen() {
            const elem = document.documentElement;
            if (elem.requestFullscreen) { elem.requestFullscreen().catch(err => {}); }
            else if (elem.webkitRequestFullscreen) { elem.webkitRequestFullscreen(); }
        }

        // Ajusta o tamanho do Canvas quando a tela muda
        function resize() {
            canvas.width = gameArea.clientWidth;
            canvas.height = gameArea.clientHeight;
            staffCenterY = canvas.height / 2;
            lineGap = Math.min(canvas.height / 10, 22); // Define tamanho da nota baseado na altura da tela
        }
        window.addEventListener('resize', resize); resize();

        // --- CLASSE NOTA (O Cora√ß√£o do Jogo) ---
        class Note {
            constructor() {
                this.x = canvas.width + 50; // Come√ßa fora da tela na direita
                
                // --- MAPEAMENTO DE POSI√á√ïES ---
                // 0 = 1¬™ Linha (Mi4). N√∫meros positivos sobem, negativos descem.
                const options = [
                    { base: 'D√≥', pos: -2 }, // D√≥ Central (Linha Sup. Inf.)
                    { base: 'R√©', pos: -1 }, 
                    { base: 'Mi', pos: 0 },  // 1¬™ Linha
                    { base: 'F√°', pos: 1 },  
                    { base: 'Sol', pos: 2 }, // 2¬™ Linha
                    { base: 'L√°', pos: 3 },
                    { base: 'Si', pos: 4 },  // 3¬™ Linha
                    { base: 'D√≥', pos: 5 },  
                    { base: 'R√©', pos: 6 },  // 4¬™ Linha
                    { base: 'Mi', pos: 7 },  
                    { base: 'F√°', pos: 8 },  // 5¬™ Linha
                    { base: 'Sol', pos: 9 }, // Espa√ßo Suplementar Superior (SEM LINHA)
                    { base: 'L√°', pos: 10 }  // 1¬™ Linha Suplementar Superior (COM LINHA)
                ];
                
                const pick = options[Math.floor(Math.random() * options.length)];
                this.baseName = pick.base; 
                this.pos = pick.pos;
                
                // --- L√ìGICA DE ACIDENTES ---
                this.accidental = null;
                if(Math.random() > 0.75) { // 25% de chance de ter acidente
                    // Evita Mi# e Si# por simplifica√ß√£o did√°tica
                    if(this.baseName !== 'Mi' && this.baseName !== 'Si') {
                         this.accidental = Math.random() > 0.5 ? 'sharp' : 'flat';
                    } else { 
                         this.accidental = 'flat'; // Apenas bemol para Mi e Si
                    }
                }
                this.marked = false; // Evita contar ponto duas vezes
                this.color = '#000';
            }

            update() {
                this.x -= gameSpeed; // Move a nota para a esquerda
                
                // [MODIFICA√á√ÉO V2.10]
                // Se a nota sair da zona verde (x < hitZone.start), morre imediatamente.
                // Isso evita que ela ande por cima da Clave.
                if (this.x < hitZone.start && !this.marked) {
                    this.marked = true; 
                    loseLife();
                    // Feedback visual no local exato onde sumiu
                    showFloatText(this.x, this.y, "Passou!", "#c0392b");
                }
            }

            draw() {
                // Calcula a altura Y baseada no √≠ndice (pos)
                const y = staffCenterY + ((4 - this.pos) * (lineGap / 2));
                ctx.save(); ctx.translate(this.x, y);
                
                // Desenha a Nota (Semibreve vazada)
                ctx.beginPath(); ctx.rotate(-0.1); // Leve inclina√ß√£o est√©tica
                ctx.lineWidth = 2; ctx.strokeStyle = this.color;
                ctx.ellipse(0, 0, lineGap * 0.7, lineGap * 0.45, 0, 0, Math.PI * 2);
                ctx.stroke(); ctx.rotate(0.1);

                // Desenha o Acidente (se houver)
                if(this.accidental) {
                    ctx.font = `bold ${lineGap*1.3}px serif`;
                    ctx.fillStyle = this.color; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(this.accidental === 'sharp' ? '‚ôØ' : '‚ô≠', -lineGap * 1.3, 0);
                }
                
                // --- DESENHO DAS LINHAS SUPLEMENTARES ---
                ctx.lineWidth = 1.5; ctx.strokeStyle = '#555';
                
                // Inferiores (Para D√≥ Central e L√° Grave)
                if (this.pos <= -2) {
                    ctx.beginPath(); ctx.moveTo(-lineGap*0.8, 0); ctx.lineTo(lineGap*0.8, 0); ctx.stroke();
                    // Se fosse L√° grave (-3), desenharia outra linha abaixo
                    if(this.pos === -3) { ctx.beginPath(); ctx.moveTo(-lineGap*0.8, -lineGap); ctx.lineTo(lineGap*0.8, -lineGap); ctx.stroke(); }
                }
                
                // Superiores (Apenas se for L√° agudo ou acima)
                // O Sol (pos 9) n√£o entra aqui, pois √© nota de espa√ßo.
                if (this.pos >= 10) {
                    const dy = (this.pos - 10) * (lineGap / 2);
                    ctx.beginPath(); ctx.moveTo(-lineGap*0.8, dy); ctx.lineTo(lineGap*0.8, dy); ctx.stroke();
                }
                
                ctx.restore();
            }
        }

        // Desenha a Pauta (5 linhas) e a Clave
        function drawStaff() {
            ctx.strokeStyle = '#555'; ctx.lineWidth = 2;
            const startY = staffCenterY - (2 * lineGap);
            
            for(let i=0; i<5; i++) {
                let y = startY + (i * lineGap);
                ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
            }
            
            // Desenha o s√≠mbolo da Clave de Sol
            ctx.fillStyle = '#2c3e50'; ctx.font = `${lineGap * 5.5}px serif`;
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('ùÑû', 60, staffCenterY - (lineGap * 0.2));

            // Desenha a Zona Verde (Alvo)
            ctx.fillStyle = 'rgba(39, 174, 96, 0.1)';
            ctx.fillRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
            ctx.strokeStyle = 'rgba(39, 174, 96, 0.4)'; ctx.lineWidth = 2;
            ctx.strokeRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
        }

        // Gerencia os bot√µes de Acidente (# e b)
        function toggleModifier(type) {
            const sharp = document.getElementById('btn-sharp');
            const flat = document.getElementById('btn-flat');
            
            if (activeModifier === type) {
                // Se clicar de novo, desativa
                activeModifier = null;
                sharp.classList.remove('active-sharp'); flat.classList.remove('active-flat');
            } else {
                // Ativa um e desativa o outro
                activeModifier = type;
                sharp.classList.toggle('active-sharp', type === 'sharp');
                flat.classList.toggle('active-flat', type === 'flat');
                if(type === 'sharp') flat.classList.remove('active-flat');
                if(type === 'flat') sharp.classList.remove('active-sharp');
            }
        }

        // Verifica se o jogador acertou a nota
        function inputNote(base) {
            if (gameState !== 'PLAYING') return;
            // Busca nota dentro da zona verde
            const target = notes.find(n => n.x > hitZone.start && n.x < hitZone.end && !n.marked);

            if (target) {
                // Confere se o nome da nota e o acidente batem
                if (target.baseName === base && target.accidental === activeModifier) {
                    score += 10 + (target.accidental ? 5 : 0);
                    playFeedback('hit'); target.marked = true;
                    notes = notes.filter(n => n !== target); // Remove a nota acertada
                    showFloatText(target.x, target.y - 50, target.accidental ? "Boa!" : "Certo!", "#27ae60");
                    
                    // Aumenta velocidade a cada 50 pontos
                    if(score % 50 === 0) gameSpeed += 0.3;
                } else {
                    lives--; playFeedback('miss');
                    showFloatText(target.x, target.y - 50, "Errou!", "#c0392b");
                    target.color = '#e74c3c'; target.marked = true;
                }
            }
            toggleModifier(null); // Reseta o acidente ap√≥s clicar na nota
            updateHUD();
        }

        // Efeito visual flutuante (+10, Errou)
        function showFloatText(x, y, text, color) {
            const el = document.createElement('div'); el.className = 'feedback';
            el.innerText = text; el.style.color = color; el.style.left = x+'px'; el.style.top = y+'px';
            gameArea.appendChild(el); setTimeout(() => el.remove(), 800);
        }

        function loseLife() {
            if (gameState !== 'PLAYING') return;
            lives--; updateHUD();
            if (lives <= 0) endGame();
            else { gameArea.style.background = 'rgba(231, 76, 60, 0.3)'; setTimeout(() => gameArea.style.background = '', 150); }
        }
        function updateHUD() { document.getElementById('score').innerText = score; document.getElementById('lives').innerText = lives; }

        // Loop de Anima√ß√£o (Roda 60x por segundo)
        function loop() {
            if (gameState !== 'PLAYING') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); // Limpa tela
            drawStaff(); // Desenha pauta
            
            spawnTimer++;
            // Cria nota nova a cada X frames
            if (spawnTimer > spawnInterval) { 
                notes.push(new Note()); 
                spawnTimer = 0; 
                if (spawnInterval > 60) spawnInterval -= 0.2; // Acelera o spawn
            }
            
            notes.forEach(n => { n.update(); n.draw(); }); // Move e desenha notas
            notes = notes.filter(n => n.x > -100 && !n.marked); // Remove notas que sa√≠ram da tela
            animationId = requestAnimationFrame(loop);
        }

        function startGame() {
            enterFullScreen();
            gameState = 'PLAYING'; score = 0; lives = 3; gameSpeed = 3.0; spawnInterval = 110; notes = []; activeModifier = null;
            document.querySelectorAll('.mod-btn').forEach(b => b.classList.remove('active-sharp', 'active-flat'));
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resize(); loop(); updateHUD();
        }
        function endGame() { gameState = 'GAMEOVER'; cancelAnimationFrame(animationId); document.getElementById('final-score').innerText = score; document.getElementById('game-over-screen').classList.remove('hidden'); }
        function resetGame() { startGame(); }
    </script>
</body>
</html>
