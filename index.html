<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestre da Clave V3.7 (Juicy)</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700;900&display=swap');
        * { box-sizing: border-box; touch-action: manipulation; } 

        body {
            margin: 0; padding: 0; background-color: #2c3e50; font-family: 'Poppins', sans-serif;
            overflow: hidden; width: 100vw; height: 100vh; color: #333; user-select: none;
            display: flex; flex-direction: column;
        }

        /* Anima√ß√£o de Shake (Erro) */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        .shake-effect { animation: shake 0.3s; }

        /* TRAVA DE ROTA√á√ÉO */
        #rotate-message {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2c3e50; color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #main-wrapper { display: none !important; }
        }

        #main-wrapper { 
            flex: 1; display: flex; flex-direction: column; width: 100%; height: 100%; 
            background: radial-gradient(circle, #fdf6e3 0%, #f0e4d0 100%);
        }

        #xp-bar-container { width: 100%; height: 6px; background: rgba(0,0,0,0.1); position: absolute; top: 0; left: 0; z-index: 20; }
        #xp-bar-fill { height: 100%; width: 0%; background: #27ae60; transition: width 0.3s; }

        #game-area { 
            flex: 1; position: relative; width: 100%; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* HUD - Direita Superior */
        #hud { 
            position: absolute; top: 15px; left: 10px; right: 10px; 
            display: flex; justify-content: flex-end; gap: 10px; align-items: center;
            pointer-events: none; z-index: 50; 
        }
        .hud-pill { 
            background: rgba(255,255,255,0.95); padding: 5px 12px; border-radius: 15px; 
            font-weight: bold; font-size: 0.9rem; color: #2c3e50; border: 1px solid #2c3e50; 
            display: flex; align-items: center; gap: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .level-badge { background: #f1c40f; color: #2c3e50; padding: 0 6px; border-radius: 8px; font-size: 0.8rem; }

        #controls-container {
            flex: 0 0 auto; height: auto; background: #34495e;
            display: flex; flex-direction: column; justify-content: center;
            padding: 10px 5px 15px 5px; gap: 5px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 60;
        }

        #notes-row { display: flex; gap: 4px; height: 55px; }
        
        .note-btn {
            flex: 1; background: linear-gradient(to bottom, #ecf0f1, #bdc3c7);
            border: none; border-radius: 6px; font-family: 'Poppins', sans-serif; font-weight: bold; font-size: 1rem;
            color: #2c3e50; cursor: pointer; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .note-btn:active { background: #95a5a6; transform: translateY(2px); }

        .btn-do { border-bottom: 4px solid #e74c3c; color: #c0392b; } 
        .btn-re { border-bottom: 4px solid #e67e22; color: #d35400; }
        .btn-mi { border-bottom: 4px solid #f1c40f; color: #f39c12; } 
        .btn-fa { border-bottom: 4px solid #2ecc71; color: #27ae60; }
        .btn-sol { border-bottom: 4px solid #3498db; color: #2980b9; } 
        .btn-la { border-bottom: 4px solid #9b59b6; color: #8e44ad; }
        .btn-si { border-bottom: 4px solid #00d2d3; color: #008c9e; }

        /* OVERLAYS */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.98); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; text-align: center; color: white;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 2rem; margin: 0 0 10px 0; color: #f1c40f; }
        p { font-size: 1.1rem; max-width: 80%; margin-bottom: 20px; color: #ecf0f1; }
        .highscore-text { font-size: 0.9rem; color: #bdc3c7; margin-top: 10px; font-weight: 300; }

        .btn-primary { 
            padding: 15px 50px; font-size: 1.3rem; background-color: #27ae60; 
            color: white; border: none; border-radius: 50px; cursor: pointer; 
            box-shadow: 0 4px 0 #1e8449; animation: pulse 2s infinite; margin-top: 10px;
        }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        /* FEEDBACK FLUTUANTE (Corre√ß√£o de Visibilidade) */
        /* Z-Index alt√≠ssimo e fixado no body para n√£o ser cortado */
        .feedback { 
            position: fixed; /* Fixado na tela, ignora containers */
            font-weight: 900; font-size: 2.5rem; 
            animation: popUp 0.8s forwards; 
            pointer-events: none; z-index: 10000; 
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #000;
            transform: translate(-50%, -50%); /* Centraliza no ponto */
        }
        @keyframes popUp { 
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 
            20% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; } 
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; } 
        }

        .levelup-flash { animation: flashScreen 0.5s; }
        @keyframes flashScreen { 0% { background: rgba(255, 255, 255, 0.8); } 100% { background: transparent; } }
    </style>
</head>
<body>

    <div id="rotate-message"><h1>‚Üª</h1><h2>Gire o celular</h2></div>

    <div id="main-wrapper">
        <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
        
        <div id="game-area">
            <canvas id="gameCanvas"></canvas>
            <div id="hud">
                <div class="hud-pill">N√≠vel <span id="level-display" class="level-badge">1</span></div>
                <div class="hud-pill">Pts: <span id="score">0</span></div>
                <div class="hud-pill">Vidas: <span id="lives">3</span></div>
            </div>
        </div>

        <div id="controls-container">
            <div id="notes-row">
                <button class="note-btn btn-do" onpointerdown="inputNote('D√≥')">D√≥</button>
                <button class="note-btn btn-re" onpointerdown="inputNote('R√©')">R√©</button>
                <button class="note-btn btn-mi" onpointerdown="inputNote('Mi')">Mi</button>
                <button class="note-btn btn-fa" onpointerdown="inputNote('F√°')">F√°</button>
                <button class="note-btn btn-sol" onpointerdown="inputNote('Sol')">Sol</button>
                <button class="note-btn btn-la" onpointerdown="inputNote('L√°')">L√°</button>
                <button class="note-btn btn-si" onpointerdown="inputNote('Si')">Si</button>
            </div>
        </div>
    </div>

    <!-- TELA INICIAL -->
    <div id="start-screen" class="overlay">
        <h1>Mestre da Clave</h1>
        <p>Comece com <strong>D√≥ e R√©</strong>.<br>Acerte para subir de n√≠vel!</p>
        <button class="btn-primary" onclick="startGame()">JOGAR</button>
        <div class="highscore-text">üèÜ Seu Recorde: <span id="start-highscore">0</span></div>
    </div>

    <!-- GAME OVER -->
    <div id="game-over-screen" class="overlay hidden">
        <h1 style="color: #e74c3c;">Fim de Jogo!</h1>
        <p>Voc√™ fez <strong id="final-score" style="color:#fff">0</strong> pontos<br>e chegou no N√≠vel <strong id="final-level" style="color:#f1c40f">1</strong></p>
        <button class="btn-primary" onclick="resetGame()">Jogar Novamente</button>
        <div class="highscore-text">üèÜ Recorde Atual: <span id="end-highscore">0</span></div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameArea = document.getElementById('game-area');
        const mainWrapper = document.getElementById('main-wrapper');

        // --- SISTEMA DE PART√çCULAS (JUICY V3.7) ---
        let particles = [];
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 5 + 2;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * 6 - 3;
                this.life = 1.0; // Opacidade
            }
            update() {
                this.x += this.speedX; this.y += this.speedY; this.life -= 0.05;
            }
            draw() {
                ctx.globalAlpha = this.life;
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
                ctx.globalAlpha = 1.0;
            }
        }
        function spawnParticles(x, y, color) {
            for(let i=0; i<10; i++) particles.push(new Particle(x, y, color));
        }

        // --- PROGRESS√ÉO ---
        const progressionList = [
            { base: 'D√≥', pos: -2 }, { base: 'R√©', pos: -1 }, 
            { base: 'Mi', pos: 0 }, { base: 'F√°', pos: 1 }, { base: 'Sol', pos: 2 }, 
            { base: 'L√°', pos: 3 }, { base: 'Si', pos: 4 }, { base: 'D√≥', pos: 5 }, 
            { base: 'R√©', pos: 6 }, { base: 'Mi', pos: 7 }, { base: 'F√°', pos: 8 },
            { base: 'Sol', pos: 9 }, { base: 'L√°', pos: 10 }
        ];

        let gameState = 'MENU';
        let score = 0; let lives = 3; let gameSpeed = 2.5; 
        let spawnTimer = 0; let spawnInterval = 120; 
        let notes = []; let animationId;
        let staffCenterY, lineGap; const hitZone = { start: 90, end: 320 }; 

        let currentLevel = 1; let hitsInLevel = 0; const HITS_TO_LEVELUP = 10; 
        let highScore = localStorage.getItem('mestreClave_record') || 0;
        document.getElementById('start-highscore').innerText = highScore;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const noteColors = { 'D√≥':'#e74c3c', 'R√©':'#e67e22', 'Mi':'#f1c40f', 'F√°':'#2ecc71', 'Sol':'#3498db', 'L√°':'#9b59b6', 'Si':'#00d2d3' };

        function playSound(freq, type='sine') {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.3);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }

        function enterFullScreen() { const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }
        function resize() { canvas.width = gameArea.clientWidth; canvas.height = gameArea.clientHeight; staffCenterY = canvas.height/2; lineGap = Math.min(canvas.height/10, 24); }
        window.addEventListener('resize', resize); resize();

        class Note {
            constructor() {
                this.x = canvas.width + 50; 
                const unlockedCount = Math.min(currentLevel + 1, progressionList.length);
                const availableNotes = progressionList.slice(0, unlockedCount);
                const pick = availableNotes[Math.floor(Math.random() * availableNotes.length)];
                
                this.baseName = pick.base; this.pos = pick.pos;
                
                // L√≥gica Desmame (V3.6)
                this.isBlack = false;
                if (currentLevel >= 13) {
                    const blackChance = (currentLevel - 12) * 0.2;
                    if (Math.random() < blackChance) this.isBlack = true;
                }
                this.color = this.isBlack ? '#000000' : noteColors[this.baseName];
                this.trueColor = noteColors[this.baseName];
                this.marked = false; 
            }
            update() {
                this.x -= gameSpeed; 
                if (this.x < hitZone.start && !this.marked) {
                    this.marked = true; loseLife();
                    showFloatText(this.x, this.y, "Passou!", "#c0392b");
                }
            }
            draw() {
                const y = staffCenterY + ((4 - this.pos) * (lineGap / 2));
                ctx.save(); ctx.translate(this.x, y);
                ctx.beginPath(); ctx.rotate(-0.1); ctx.lineWidth = 3; ctx.strokeStyle = this.color;
                ctx.ellipse(0, 0, lineGap * 0.7, lineGap * 0.45, 0, 0, Math.PI * 2);
                ctx.stroke(); ctx.rotate(0.1);
                ctx.lineWidth = 1.5; ctx.strokeStyle = '#555';
                if (this.pos <= -2) { ctx.beginPath(); ctx.moveTo(-lineGap*0.8, 0); ctx.lineTo(lineGap*0.8, 0); ctx.stroke(); 
                    if(this.pos === -3) { ctx.beginPath(); ctx.moveTo(-lineGap*0.8, -lineGap); ctx.lineTo(lineGap*0.8, -lineGap); ctx.stroke(); } }
                if (this.pos >= 10) { const dy = (this.pos - 10)*(lineGap/2); ctx.beginPath(); ctx.moveTo(-lineGap*0.8, dy); ctx.lineTo(lineGap*0.8, dy); ctx.stroke(); }
                ctx.restore();
            }
        }

        function drawStaff() {
            ctx.strokeStyle = '#555'; ctx.lineWidth = 2; const startY = staffCenterY - (2 * lineGap);
            for(let i=0; i<5; i++) { let y = startY + (i * lineGap); ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
            ctx.fillStyle = '#2c3e50'; ctx.font = `${lineGap * 5.5}px serif`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('ùÑû', 60, staffCenterY + (lineGap * 0.8));
            ctx.fillStyle = 'rgba(39, 174, 96, 0.1)'; ctx.fillRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
            ctx.strokeStyle = 'rgba(39, 174, 96, 0.4)'; ctx.lineWidth = 2; ctx.strokeRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
        }

        function inputNote(base) {
            if (gameState !== 'PLAYING') return;
            const target = notes.find(n => n.x > hitZone.start && n.x < hitZone.end && !n.marked);

            if (target) {
                if (target.baseName === base) {
                    score += 10; hitsInLevel++;
                    playSound(880, 'sine'); target.marked = true;
                    // SPAWN PARTICLES (JUICY)
                    spawnParticles(target.x, target.y + (staffCenterY + ((4 - target.pos) * (lineGap / 2)) - target.y), target.trueColor); 
                    // Corre√ß√£o: Posi√ß√£o Y da part√≠cula deve ser a posi√ß√£o desenhada, n√£o a l√≥gica
                    const drawY = staffCenterY + ((4 - target.pos) * (lineGap / 2));
                    spawnParticles(target.x, drawY, target.trueColor);

                    notes = notes.filter(n => n !== target); 
                    showFloatText(target.x, drawY - 50, "Certo!", target.trueColor);
                    checkLevelUp();
                } else {
                    lives--; playSound(150, 'sawtooth');
                    // SCREEN SHAKE (JUICY)
                    triggerShake();
                    const drawY = staffCenterY + ((4 - target.pos) * (lineGap / 2));
                    showFloatText(target.x, drawY - 50, "Errou!", "#c0392b");
                    target.color = '#e74c3c'; target.marked = true;
                }
            }
            updateHUD();
        }

        function checkLevelUp() {
            const progress = (hitsInLevel / HITS_TO_LEVELUP) * 100;
            document.getElementById('xp-bar-fill').style.width = progress + '%';
            if (hitsInLevel >= HITS_TO_LEVELUP) {
                if (currentLevel + 1 < progressionList.length) {
                    currentLevel++; hitsInLevel = 0; 
                    if(currentLevel <= 12) { gameSpeed += 0.2; spawnInterval -= 2; }
                    let msg = `N√≠vel ${currentLevel}!`;
                    if (currentLevel >= 13 && currentLevel <= 17) msg = "Modo Desmame!";
                    playSound(1200, 'square'); document.getElementById('xp-bar-fill').style.width = '0%'; 
                    showFloatText(canvas.width/2, canvas.height/2, msg, "#f1c40f");
                    const flash = document.createElement('div'); flash.className = 'overlay levelup-flash';
                    document.body.appendChild(flash); setTimeout(() => flash.remove(), 500);
                }
            }
        }

        // TEXTO FLUTUANTE (Corre√ß√£o: Append to Body)
        function showFloatText(x, y, text, color) {
            // Ajusta coordenadas para serem globais (body)
            const rect = canvas.getBoundingClientRect();
            const globalX = rect.left + x;
            const globalY = rect.top + y;

            const el = document.createElement('div'); el.className = 'feedback';
            el.innerText = text; el.style.color = color; 
            el.style.left = globalX+'px'; el.style.top = globalY+'px';
            document.body.appendChild(el); // Fixa no body pra n√£o cortar
            setTimeout(() => el.remove(), 800);
        }

        // SCREEN SHAKE
        function triggerShake() {
            mainWrapper.classList.add('shake-effect');
            setTimeout(() => mainWrapper.classList.remove('shake-effect'), 300);
        }

        function loseLife() {
            if (gameState !== 'PLAYING') return;
            lives--; updateHUD(); triggerShake(); // Shake tbm ao perder vida por passar
            if (lives <= 0) endGame();
            else { gameArea.style.background = 'rgba(231, 76, 60, 0.3)'; setTimeout(() => gameArea.style.background = '', 150); }
        }
        
        function updateHUD() { 
            document.getElementById('score').innerText = score; 
            document.getElementById('level-display').innerText = currentLevel; 
            document.getElementById('lives').innerText = lives; 
        }

        function loop() {
            if (gameState !== 'PLAYING') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            drawStaff(); 
            
            // Desenha Part√≠culas
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].update();
                particles[i].draw();
                if(particles[i].life <= 0) particles.splice(i, 1);
            }

            spawnTimer++;
            if (spawnTimer > spawnInterval) { notes.push(new Note()); spawnTimer = 0; }
            notes.forEach(n => { n.update(); n.draw(); }); 
            notes = notes.filter(n => n.x > -100 && !n.marked); 
            animationId = requestAnimationFrame(loop);
        }

        function startGame() {
            enterFullScreen();
            gameState = 'PLAYING'; score = 0; lives = 3; 
            currentLevel = 1; hitsInLevel = 0; gameSpeed = 2.5; spawnInterval = 120;
            document.getElementById('xp-bar-fill').style.width = '0%';
            notes = []; particles = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            resize(); loop(); updateHUD();
        }

        function endGame() { 
            gameState = 'GAMEOVER'; cancelAnimationFrame(animationId); 
            if (score > highScore) { highScore = score; localStorage.setItem('mestreClave_record', highScore); }
            document.getElementById('final-score').innerText = score;
            document.getElementById('final-level').innerText = currentLevel;
            document.getElementById('end-highscore').innerText = highScore;
            document.getElementById('start-highscore').innerText = highScore;
            document.getElementById('game-over-screen').classList.remove('hidden'); 
        }
        function resetGame() { startGame(); }
    </script>
</body>
</html>
