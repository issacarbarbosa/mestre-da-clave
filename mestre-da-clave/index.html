<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mestre da Clave | Issa Academy</title>

    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF25LGNKEJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LF25LGNKEJ');
    </script>

    <!-- Microsoft Clarity -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "ujlb9c5vzi");
    </script>

    <!-- Fonte (Atualizada para Nunito) e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* === DESIGN SYSTEM V2 (Gamified) === */
        :root {
            --brand-blue: #1a3c5a;
            --brand-gold: #c5a059;
            --btn-green: #58cc02; --shade-green: #58a700;
            --btn-red: #ff4b4b;   --shade-red: #ea2b2b;
            --btn-blue: #1cb0f6;  --shade-blue: #1899d6;
            --btn-gray: #e5e5e5;  --shade-gray: #cecece;
            --white: #ffffff;
            --text-main: #4b4b4b;
            --radius: 16px;
        }

        * { box-sizing: border-box; touch-action: manipulation; } 

        body {
            margin: 0; padding: 0; 
            /* Fundo escuro mantido para contraste do jogo, mas suavizado */
            background: radial-gradient(circle at center, #2c3e50 0%, #1a252f 100%);
            font-family: 'Nunito', sans-serif;
            overflow: hidden; width: 100vw; height: 100vh; color: #333; user-select: none;
            display: flex; flex-direction: column;
        }

        /* TELA DE ROTA√á√ÉO */
        #rotate-message {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--brand-blue); color: white; z-index: 9999;
            flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px;
        }
        @media screen and (orientation: portrait) {
            #rotate-message { display: flex; }
            #main-wrapper { display: none !important; }
        }

        /* √ÅREA PRINCIPAL */
        #main-wrapper { 
            flex: 1; display: flex; flex-direction: column; 
            width: 100%; height: 100%;
            max-width: 850px; margin: 0 auto; 
            /* Fundo Papel Suave */
            background: radial-gradient(circle, #fdf6e3 0%, #f0e4d0 100%);
            box-shadow: 0 0 50px rgba(0,0,0,0.5); position: relative;
        }

        #xp-bar-container { width: 100%; height: 8px; background: rgba(0,0,0,0.1); position: absolute; top: 0; left: 0; z-index: 20; }
        #xp-bar-fill { height: 100%; width: 0%; background: var(--btn-green); transition: width 0.3s; box-shadow: 0 0 10px var(--btn-green); }

        #game-area { 
            flex: 1; position: relative; width: 100%; overflow: hidden; 
            display: flex; justify-content: center; align-items: center; 
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* HUD E NAVEGA√á√ÉO (Atualizados para V2) */
        .nav-btn {
            position: absolute; top: 15px; z-index: 60;
            background: rgba(255,255,255,0.95); border: none;
            width: 45px; height: 45px; border-radius: 50%;
            color: var(--brand-blue); font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            display: flex; justify-content: center; align-items: center;
            transition: transform 0.1s;
            text-decoration: none;
        }
        .nav-btn:active { transform: translateY(2px); box-shadow: none; }
        .nav-btn.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }

        #btn-back { left: 15px; }
        #btn-pause { right: 15px; font-size: 1rem; flex-direction: column; gap: 0px; line-height: 1; }
        #btn-pause span { font-size: 0.6rem; font-weight: 800; color: var(--btn-red); margin-top: 2px; }

        #hud { 
            position: absolute; top: 15px; left: 0; right: 0; 
            display: flex; justify-content: center; gap: 10px; align-items: center;
            pointer-events: none; z-index: 50; 
        }
        .hud-pill { 
            background: rgba(255,255,255,0.9); padding: 5px 15px; border-radius: 20px; 
            font-weight: 800; font-size: 1.1rem; color: var(--text-main); 
            border-bottom: 3px solid #ccc; /* Estilo Juicy sutil */
            display: flex; align-items: center; gap: 6px; 
        }
        .level-badge { background: var(--brand-gold); color: white; padding: 0 8px; border-radius: 8px; font-size: 0.9rem; }

        /* CONTROLES (PIANO GAMIFICADO) */
        #controls-container {
            flex: 0 0 auto; height: auto; background: #34495e;
            display: flex; flex-direction: column; justify-content: center;
            padding: 10px 5px 15px 5px; gap: 5px;
            box-shadow: 0 -4px 10px rgba(0,0,0,0.3); z-index: 60;
        }
        #notes-row { display: flex; gap: 4px; height: 60px; } /* Altura levemente maior */
        
        .note-btn {
            flex: 1; background: var(--white);
            border: none; border-bottom: 5px solid #bdc3c7; /* Borda 3D */
            border-radius: 10px; 
            font-family: 'Nunito', sans-serif; font-weight: 800; font-size: 1.1rem;
            color: var(--text-main); cursor: pointer; 
            transition: transform 0.1s;
        }
        .note-btn:active { transform: translateY(4px); border-bottom-width: 1px; background: #f0f0f0; }

        /* Cores das Notas (Estilo V2) */
        .btn-do { color: #e74c3c; border-bottom-color: #c0392b; } 
        .btn-re { color: #e67e22; border-bottom-color: #d35400; }
        .btn-mi { color: #f1c40f; border-bottom-color: #f39c12; } 
        .btn-fa { color: #2ecc71; border-bottom-color: #27ae60; }
        .btn-sol { color: #3498db; border-bottom-color: #2980b9; } 
        .btn-la { color: #9b59b6; border-bottom-color: #8e44ad; }
        .btn-si { color: #e84393; border-bottom-color: #c03676; } /* Si Rosa */

        /* === NOVOS OVERLAYS (ESTILO DUOLINGO) === */
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(19, 31, 36, 0.95); /* Fundo escuro focado */
            backdrop-filter: blur(5px);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 9999; 
            padding: 20px;
            transition: opacity 0.3s;
            /* Habilita rolagem se a tela for muito pequena (paisagem) */
            overflow-y: auto;
        }
        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* Card Central Branco */
        .modal-card {
            background: var(--white);
            padding: 30px;
            border-radius: 24px;
            text-align: center;
            width: 100%; max-width: 400px;
            box-shadow: 0 10px 0 rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            /* Garante margem para rolagem em telas pequenas */
            margin: auto; 
        }

        /* Ajuste para telas baixas (Paisagem no celular) */
        @media (max-height: 500px) {
            .overlay {
                display: block; /* Remove flex para permitir scroll nativo correto */
                text-align: center;
            }
            .modal-card {
                margin-top: 20px;
                margin-bottom: 20px;
            }
        }

        .modal-title { font-size: 2rem; font-weight: 900; color: var(--brand-gold); margin: 10px 0; letter-spacing: -1px; }
        .modal-text { font-size: 1.1rem; color: #666; margin-bottom: 25px; line-height: 1.5; font-weight: 600; }
        .highscore-text { font-size: 0.9rem; color: #999; font-weight: 700; text-transform: uppercase; margin-top: 15px; }

        /* Estilos para Imagens do Fufu */
        .mascot-img-lg {
            width: 120px; height: auto; display: block; margin: 0 auto 10px;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.15));
        }
        
        .mascot-img-md {
            width: 100px; height: auto; display: block; margin: 0 auto 10px;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.15));
        }

        /* Bot√µes de A√ß√£o Juicy */
        .btn-action {
            display: block; width: 100%;
            padding: 16px; border: none; border-radius: 16px;
            font-size: 1.2rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; transition: transform 0.1s;
            margin-bottom: 10px; text-decoration: none; color: white; text-align: center;
        }
        .btn-action:active { transform: translateY(4px); border-bottom-width: 0 !important; margin-top: 4px; margin-bottom: 6px; }

        .btn-green { background: var(--btn-green); border-bottom: 5px solid var(--shade-green); }
        .btn-red { background: var(--btn-red); border-bottom: 5px solid var(--shade-red); }
        
        /* NOVO BOT√ÉO CINZA (Para Voltar) */
        .btn-gray { background: var(--btn-gray); color: var(--text-main); border-bottom: 5px solid var(--shade-gray); }
        
        .btn-transparent { background: transparent; color: #999; border: 2px solid transparent; font-size: 1rem; }
        .btn-transparent:hover { color: var(--text-main); }

        /* Anima√ß√µes */
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .feedback { 
            position: fixed; font-weight: 900; font-size: 2.5rem; 
            animation: popUp 0.8s forwards; pointer-events: none; z-index: 10000; 
            text-shadow: 2px 2px 0 #fff, -1px -1px 0 #000; transform: translate(-50%, -50%); 
        }
        @keyframes popUp { 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; } 20% { transform: translate(-50%, -80%) scale(1.2); opacity: 1; } 100% { transform: translate(-50%, -200%) scale(1); opacity: 0; } }

        .levelup-banner {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: 900; color: #f1c40f;
            text-shadow: 0 0 20px rgba(241, 196, 15, 0.8), 0 4px 10px rgba(0,0,0,0.5); 
            z-index: 10001; pointer-events: none;
            animation: bannerPop 1.8s forwards; text-align: center; width: 100%;
        }
        .levelup-sub { font-size: 1.5rem; color: white; display: block; margin-top: 10px; }
        
        @keyframes bannerPop {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            15% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            25% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1.5); opacity: 0; }
        }
        
        .shake-effect { animation: shake 0.3s; }
        @keyframes shake { 0% { transform: translate(1px, 1px) rotate(0deg); } 10% { transform: translate(-1px, -2px) rotate(-1deg); } 20% { transform: translate(-3px, 0px) rotate(1deg); } 30% { transform: translate(3px, 2px) rotate(0deg); } 40% { transform: translate(1px, -1px) rotate(1deg); } 50% { transform: translate(-1px, 2px) rotate(-1deg); } 60% { transform: translate(-3px, 1px) rotate(0deg); } 70% { transform: translate(3px, 1px) rotate(-1deg); } 80% { transform: translate(-1px, -1px) rotate(1deg); } 90% { transform: translate(1px, 2px) rotate(0deg); } 100% { transform: translate(1px, -2px) rotate(-1deg); } }
    </style>
</head>
<body>

    <div id="rotate-message"><h1>‚Üª</h1><h2>Gire o celular</h2></div>

    <div id="main-wrapper">
        <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
        
        <!-- Bot√£o Voltar (Link para a Home) -->
        <a href="../index.html" id="btn-back" class="nav-btn" aria-label="Voltar para Home">
            <i class="fas fa-arrow-left"></i>
        </a>

        <!-- Bot√£o Pause (Com contador) -->
        <button id="btn-pause" class="nav-btn" onclick="togglePause()" aria-label="Pausar Jogo">
            <i class="fas fa-pause"></i>
            <span id="pause-count">3</span>
        </button>

        <div id="game-area">
            <canvas id="gameCanvas"></canvas>
            
            <div id="hud">
                <div class="hud-pill">‚≠ê <span id="level-display" class="level-badge">1</span></div>
                <div class="hud-pill">üéØ <span id="score">0</span></div>
                <div class="hud-pill">‚ù§Ô∏è <span id="lives">3</span></div>
            </div>
        </div>

        <div id="controls-container">
            <div id="notes-row">
                <button class="note-btn btn-do" onpointerdown="inputNote('D√≥')">D√≥</button>
                <button class="note-btn btn-re" onpointerdown="inputNote('R√©')">R√©</button>
                <button class="note-btn btn-mi" onpointerdown="inputNote('Mi')">Mi</button>
                <button class="note-btn btn-fa" onpointerdown="inputNote('F√°')">F√°</button>
                <button class="note-btn btn-sol" onpointerdown="inputNote('Sol')">Sol</button>
                <button class="note-btn btn-la" onpointerdown="inputNote('L√°')">L√°</button>
                <button class="note-btn btn-si" onpointerdown="inputNote('Si')">Si</button>
            </div>
        </div>
    </div>

    <!-- TELA DE IN√çCIO -->
    <div id="start-screen" class="overlay">
        <div class="modal-card">
            <!-- Avatar Inicial: Capa Mestre da Clave -->
            <img src="../assets/fufu-capa-mestre-da-clave.png" class="mascot-img-lg" alt="Fufu Mestre da Clave">
            <h1 class="modal-title">Mestre da Clave</h1>
            <p class="modal-text">Comece com <strong>D√≥ e R√©</strong>.<br>Acerte e suba de n√≠vel!üöÄ</p>
            <button class="btn-action btn-green" onclick="startGame()">COME√áAR</button>
            
            <!-- Bot√£o Voltar agora √© VIS√çVEL (Cinza) -->
            <a href="../index.html" class="btn-action btn-gray">VOLTAR</a>
            
            <div class="highscore-text">üèÜ Seu Recorde: <span id="start-highscore">0</span></div>
        </div>
    </div>

    <!-- TELA DE PAUSA -->
    <div id="pause-screen" class="overlay pause-overlay hidden">
        <div class="modal-card">
            <!-- Imagem Pausa (Alternada via JS) -->
            <img id="pause-fufu-img" src="../assets/fufu-pensativo.png" class="mascot-img-md" alt="Fufu Pausa">
            <h1 class="modal-title" style="font-size: 1.5rem;">Pausado</h1>
            <p class="modal-text">Pausas restantes: <strong id="pause-msg-count" style="color: var(--brand-gold);">3</strong></p>
            <button class="btn-action btn-green" onclick="togglePause()">CONTINUAR</button>
            <a href="../index.html" class="btn-action btn-red">SAIR</a>
        </div>
    </div>

    <!-- TELA DE GAME OVER -->
    <div id="game-over-screen" class="overlay hidden">
        <div class="modal-card">
            <!-- Imagem Game Over (Alternada via JS) -->
            <img id="go-fufu-img" src="../assets/fufu-erro-acontece.png" class="mascot-img-lg" alt="Fufu Game Over">
            <h1 class="modal-title" style="color: var(--btn-red);">Fim de Jogo!</h1>
            
            <div style="background: #f7f9fa; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <p style="margin:0; font-size:0.9rem; color:#888;">PONTUA√á√ÉO</p>
                <div style="font-size: 2.5rem; font-weight:900; color: var(--brand-blue);" id="final-score">0</div>
                <div style="font-size: 1rem; color: var(--brand-gold); font-weight:800;">N√çVEL <span id="final-level">1</span></div>
            </div>

            <button class="btn-action btn-green" onclick="resetGame()">JOGAR NOVAMENTE</button>
            
            <!-- Bot√£o Sair simplificado -->
            <a href="../index.html" class="btn-action btn-red">SAIR</a>
            
            <div class="highscore-text">üèÜ Recorde Atual: <span id="end-highscore">0</span></div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const gameArea = document.getElementById('game-area');
        const mainWrapper = document.getElementById('main-wrapper');

        // === RECURSOS VISUAIS ===
        const MusicFont = {
            NOTEHEAD: new Path2D("M0 4.35c3.6 0 6.5-1.95 6.5-4.35s-2.9-4.35-6.5-4.35-6.5 1.95-6.5 4.35 2.9 4.35 6.5 4.35zm0-1c-2.4 0-4.4-1.5-4.4-3.35s2-3.35 4.4-3.35 4.4 1.5 4.4 3.35-2 3.35-4.4 3.35z")
        };

        const AudioEngine = {
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            posToFreq: {
                '-3': 246.94, '-2': 261.63, '-1': 293.66, '0': 329.63,
                '1': 349.23, '2': 392.00, '3': 440.00, '4': 493.88,
                '5': 523.25, '6': 587.33, '7': 659.25, '8': 698.46,
                '9': 783.99, '10': 880.00
            },
            init: function() { if (this.ctx.state === 'suspended') this.ctx.resume(); },
            
            playTone: function(freq, startTime, duration = 0.5) {
                const osc1 = this.ctx.createOscillator(); const osc2 = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc1.type = 'triangle'; osc1.frequency.value = freq;
                osc2.type = 'sine'; osc2.frequency.value = freq;
                const now = startTime || this.ctx.currentTime;
                gain.gain.setValueAtTime(0, now);
                gain.gain.linearRampToValueAtTime(0.2, now + 0.02); 
                gain.gain.exponentialRampToValueAtTime(0.001, now + duration);
                osc1.connect(gain); osc2.connect(gain); gain.connect(this.ctx.destination);
                osc1.start(now); osc2.start(now); osc1.stop(now + duration); osc2.stop(now + duration);
            },

            playLevelUpFanfare: function() {
                this.init();
                const now = this.ctx.currentTime;
                const notes = [
                    { freq: 523.25, time: now, dur: 0.15 },
                    { freq: 659.25, time: now + 0.15, dur: 0.15 },
                    { freq: 783.99, time: now + 0.3, dur: 0.6 }
                ];

                notes.forEach(n => {
                    const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                    osc.type = 'sawtooth'; osc.frequency.value = n.freq;
                    gain.gain.setValueAtTime(0, n.time); gain.gain.linearRampToValueAtTime(0.15, n.time + 0.05); gain.gain.exponentialRampToValueAtTime(0.001, n.time + n.dur);
                    osc.connect(gain); gain.connect(this.ctx.destination); osc.start(n.time); osc.stop(n.time + n.dur);
                });
            },

            playRewardChord: function(pos) {
                this.init(); const rootFreq = this.posToFreq[pos]; if (!rootFreq) return;
                const thirdFreq = rootFreq * 1.25992; const fifthFreq = rootFreq * 1.49831;
                const now = this.ctx.currentTime;
                this.playTone(rootFreq, now, 0.7);
                this.playTone(thirdFreq, now + 0.06, 0.7);
                this.playTone(fifthFreq, now + 0.12, 0.7);
            },
            playError: function() {
                this.init(); const osc = this.ctx.createOscillator(); const gain = this.ctx.createGain();
                osc.type = 'sawtooth'; osc.frequency.setValueAtTime(110, this.ctx.currentTime);
                osc.frequency.linearRampToValueAtTime(80, this.ctx.currentTime + 0.3);
                gain.gain.setValueAtTime(0.2, this.ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.ctx.currentTime + 0.3);
                osc.connect(gain); gain.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + 0.3);
            }
        };

        let particles = [];
        class Particle {
            constructor(x, y, color, speedX, speedY, lifeDecay) {
                this.x = x; this.y = y; this.color = color;
                this.size = Math.random() * 5 + 2;
                this.speedX = speedX !== undefined ? speedX : Math.random() * 6 - 3;
                this.speedY = speedY !== undefined ? speedY : Math.random() * 6 - 3;
                this.life = 1.0;
                this.lifeDecay = lifeDecay || 0.05;
            }
            update() { this.x += this.speedX; this.y += this.speedY; this.life -= this.lifeDecay; }
            draw() { 
                ctx.globalAlpha = Math.max(0, this.life); ctx.fillStyle = this.color; 
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill(); 
                ctx.globalAlpha = 1.0; 
            }
        }
        function spawnParticles(x, y, color) { for(let i=0; i<10; i++) particles.push(new Particle(x, y, color)); }

        function spawnConfetti() {
            const colors = ['#e74c3c', '#e67e22', '#f1c40f', '#2ecc71', '#3498db', '#9b59b6'];
            for(let i=0; i<100; i++) {
                const x = Math.random() * canvas.width;
                const y = -10 - (Math.random() * 50);
                const color = colors[Math.floor(Math.random() * colors.length)];
                particles.push(new Particle(x, y, color, (Math.random() * 2) - 1, (Math.random() * 5) + 2, 0.008));
            }
        }

        const progressionList = [
            { base: 'D√≥', pos: -2 }, { base: 'R√©', pos: -1 }, 
            { base: 'Mi', pos: 0 }, { base: 'F√°', pos: 1 }, { base: 'Sol', pos: 2 }, 
            { base: 'L√°', pos: 3 }, { base: 'Si', pos: 4 }, { base: 'D√≥', pos: 5 }, 
            { base: 'R√©', pos: 6 }, { base: 'Mi', pos: 7 }, { base: 'F√°', pos: 8 },
            { base: 'Sol', pos: 9 }, { base: 'L√°', pos: 10 }
        ];

        let gameState = 'MENU';
        let score = 0; let lives = 3; 
        
        let gameSpeedPPS = 150; 
        let spawnTimer = 0; 
        let spawnIntervalMS = 2000; 
        
        // CONTROLE DE PAUSA
        let pausesLeft = 3;
        let isPaused = false;

        let notes = []; let animationId;
        let lastTime = 0;

        let staffCenterY, lineGap; const hitZone = { start: 90, end: 320 }; 

        let currentLevel = 1; let hitsInLevel = 0; const HITS_TO_LEVELUP = 10; 
        let highScore = localStorage.getItem('mestreClave_record') || 0;
        document.getElementById('start-highscore').innerText = highScore;

        // Atualizado Si para Rosa (#e84393)
        const noteColors = { 
            'D√≥':'#e74c3c', 'R√©':'#e67e22', 'Mi':'#f1c40f', 
            'F√°':'#2ecc71', 'Sol':'#3498db', 'L√°':'#9b59b6', 'Si':'#e84393' 
        };

        function enterFullScreen() { const el = document.documentElement; if(el.requestFullscreen) el.requestFullscreen().catch(()=>{}); }
        
        function resize() { 
            canvas.width = gameArea.clientWidth; 
            canvas.height = gameArea.clientHeight; 
            staffCenterY = canvas.height/2; 
            lineGap = Math.min(canvas.height/10, 24); 
        }
        window.addEventListener('resize', resize); resize();

        class Note {
            constructor() {
                this.x = canvas.width + 50; 
                const unlockedCount = Math.min(currentLevel + 1, progressionList.length);
                const availableNotes = progressionList.slice(0, unlockedCount);
                const pick = availableNotes[Math.floor(Math.random() * availableNotes.length)];
                this.baseName = pick.base; this.pos = pick.pos;
                this.isBlack = false;
                if (currentLevel >= 13) {
                    const blackChance = (currentLevel - 12) * 0.2;
                    if (Math.random() < blackChance) this.isBlack = true;
                }
                this.color = this.isBlack ? '#000000' : noteColors[this.baseName];
                this.trueColor = noteColors[this.baseName];
                this.marked = false; 
            }
            update(dt) {
                this.x -= gameSpeedPPS * dt; 
                if (this.x < hitZone.start && !this.marked) {
                    this.marked = true; loseLife();
                    showFloatText(this.x, this.y, "Passou!", "#c0392b");
                }
            }
            draw() {
                const y = staffCenterY + ((4 - this.pos) * (lineGap / 2));
                ctx.save(); ctx.translate(this.x, y);
                const noteScale = lineGap / 8.7; 
                ctx.scale(noteScale, noteScale);
                ctx.fillStyle = this.color;
                ctx.fill(MusicFont.NOTEHEAD);
                ctx.restore();

                ctx.lineWidth = 3; ctx.strokeStyle = '#555'; 
                if (this.pos <= -2) { 
                    const lineY = staffCenterY + ((4 - (-2)) * (lineGap / 2));
                    ctx.beginPath(); ctx.moveTo(this.x - lineGap*1.1, lineY); ctx.lineTo(this.x + lineGap*1.1, lineY); ctx.stroke(); 
                    if(this.pos === -3) { 
                        const lineY2 = staffCenterY + ((4 - (-3)) * (lineGap / 2));
                        ctx.beginPath(); ctx.moveTo(this.x - lineGap*1.1, lineY2); ctx.lineTo(this.x + lineGap*1.1, lineY2); ctx.stroke(); 
                    } 
                }
                if (this.pos >= 10) { 
                    const dy = staffCenterY + ((4 - 10) * (lineGap / 2));
                    ctx.beginPath(); ctx.moveTo(this.x - lineGap*1.1, dy); ctx.lineTo(this.x + lineGap*1.1, dy); ctx.stroke(); 
                }
            }
        }

        function drawStaff() {
            ctx.strokeStyle = '#555'; ctx.lineWidth = 2; const startY = staffCenterY - (2 * lineGap);
            for(let i=0; i<5; i++) { let y = startY + (i * lineGap); ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }
            
            ctx.fillStyle = '#2c3e50'; ctx.font = `${lineGap * 5.5}px serif`; 
            ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText('ùÑû', 50, staffCenterY + (lineGap * 0.8));

            ctx.fillStyle = 'rgba(39, 174, 96, 0.1)'; ctx.fillRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
            ctx.strokeStyle = 'rgba(39, 174, 96, 0.4)'; ctx.lineWidth = 2; ctx.strokeRect(hitZone.start, 0, hitZone.end - hitZone.start, canvas.height);
        }

        function inputNote(base) {
            if (gameState !== 'PLAYING' || isPaused) return; 
            const target = notes.find(n => n.x > hitZone.start && n.x < hitZone.end && !n.marked);
            if (target) {
                if (target.baseName === base) {
                    score += 10; hitsInLevel++;
                    AudioEngine.playRewardChord(target.pos);
                    target.marked = true;
                    const drawY = staffCenterY + ((4 - target.pos) * (lineGap / 2));
                    spawnParticles(target.x, drawY, target.trueColor);
                    notes = notes.filter(n => n !== target); 
                    showFloatText(target.x, drawY - 50, target.baseName + "!", target.trueColor);
                    checkLevelUp();
                } else {
                    lives--; AudioEngine.playError();
                    triggerShake();
                    updateHUD(); 
                    if (lives <= 0) { endGame(); return; }
                    const drawY = staffCenterY + ((4 - target.pos) * (lineGap / 2));
                    showFloatText(target.x, drawY - 50, "Errou!", "#c0392b");
                    target.color = '#e74c3c'; target.marked = true;
                }
            }
            updateHUD();
        }

        function togglePause() {
            if (gameState !== 'PLAYING') return;

            const pauseBtn = document.getElementById('btn-pause');
            const pauseScreen = document.getElementById('pause-screen');
            const pauseImg = document.getElementById('pause-fufu-img');

            if (isPaused) {
                isPaused = false;
                pauseScreen.classList.add('hidden');
                lastTime = performance.now(); 
                loop(lastTime);
                return;
            }

            if (pausesLeft > 0) {
                isPaused = true;
                pausesLeft--;
                
                document.getElementById('pause-count').innerText = pausesLeft;
                document.getElementById('pause-msg-count').innerText = pausesLeft;
                
                // L√≥gica de Sorteio de Imagem na Pausa
                const pauseImages = ["../assets/fufu-pensativo.png", "../assets/fufu-erro-tapinha.png"];
                const randomPauseImg = pauseImages[Math.floor(Math.random() * pauseImages.length)];
                pauseImg.src = randomPauseImg;

                pauseScreen.classList.remove('hidden');
                
                cancelAnimationFrame(animationId);

                if (pausesLeft === 0) {
                    pauseBtn.classList.add('disabled');
                    pauseBtn.style.opacity = '0.5';
                }
            } else {
                pauseBtn.classList.add('shake-effect');
                setTimeout(() => pauseBtn.classList.remove('shake-effect'), 300);
            }
        }

        function checkLevelUp() {
            const progress = (hitsInLevel / HITS_TO_LEVELUP) * 100;
            document.getElementById('xp-bar-fill').style.width = progress + '%';
            if (hitsInLevel >= HITS_TO_LEVELUP) {
                currentLevel++; hitsInLevel = 0; 

                if(typeof gtag !== 'undefined') {
                    gtag('event', 'level_up', { 'level': currentLevel });
                }

                if(currentLevel <= 12) { gameSpeedPPS += 12; spawnIntervalMS -= 40; }
                let msg = `N√≠vel ${currentLevel}`; let subMsg = "Nova Nota!";
                if (currentLevel > 12) subMsg = "Modo Partitura!";
                if (currentLevel > 17) subMsg = "Mestre Supremo!";
                AudioEngine.playLevelUpFanfare(); 
                document.getElementById('xp-bar-fill').style.width = '0%'; 
                spawnConfetti();
                showLevelBanner(msg, subMsg);
            }
        }

        function showFloatText(x, y, text, color) {
            const rect = canvas.getBoundingClientRect(); const globalX = rect.left + x; const globalY = rect.top + y;
            const el = document.createElement('div'); el.className = 'feedback'; el.innerText = text; el.style.color = color; 
            el.style.left = globalX+'px'; el.style.top = globalY+'px'; document.body.appendChild(el); setTimeout(() => el.remove(), 800);
        }

        function showLevelBanner(title, subtitle) {
            const el = document.createElement('div'); el.className = 'levelup-banner';
            el.innerHTML = `${title}<span class="levelup-sub">${subtitle}</span>`;
            document.body.appendChild(el); setTimeout(() => el.remove(), 1800); 
        }

        function triggerShake() { mainWrapper.classList.add('shake-effect'); setTimeout(() => mainWrapper.classList.remove('shake-effect'), 300); }

        function loseLife() {
            if (gameState !== 'PLAYING') return;
            lives--; updateHUD(); triggerShake(); AudioEngine.playError();
            if (lives <= 0) endGame();
            else { gameArea.style.background = 'rgba(231, 76, 60, 0.3)'; setTimeout(() => gameArea.style.background = '', 150); }
        }
        
        function updateHUD() { 
            document.getElementById('score').innerText = score; 
            document.getElementById('level-display').innerText = currentLevel; 
            document.getElementById('lives').innerText = lives; 
        }

        function loop(timestamp) {
            if (gameState !== 'PLAYING' || isPaused) return; 
            if (!lastTime) lastTime = timestamp;
            const deltaTime = (timestamp - lastTime) / 1000; lastTime = timestamp;
            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            drawStaff(); 
            for(let i=particles.length-1; i>=0; i--) { particles[i].update(); particles[i].draw(); if(particles[i].life <= 0) particles.splice(i, 1); }
            spawnTimer += (deltaTime * 1000); 
            if (spawnTimer > spawnIntervalMS) { notes.push(new Note()); spawnTimer = 0; }
            notes.forEach(n => { n.update(deltaTime); n.draw(); }); 
            notes = notes.filter(n => n.x > -100 && !n.marked); 
            animationId = requestAnimationFrame(loop);
        }

        function startGame() {
            enterFullScreen(); AudioEngine.init(); 
            
            if(typeof gtag !== 'undefined') {
                gtag('event', 'game_start', { 'level': 1 });
            }

            gameState = 'PLAYING'; score = 0; lives = 3; 
            currentLevel = 1; hitsInLevel = 0; gameSpeedPPS = 150; spawnIntervalMS = 2000; 
            
            pausesLeft = 3;
            isPaused = false;
            document.getElementById('pause-count').innerText = pausesLeft;
            document.getElementById('btn-pause').classList.remove('disabled');
            document.getElementById('btn-pause').style.opacity = '1';

            document.getElementById('xp-bar-fill').style.width = '0%';
            notes = []; particles = [];
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('game-over-screen').classList.add('hidden');
            resize(); lastTime = performance.now(); loop(lastTime); updateHUD();
        }

        function endGame() { 
            gameState = 'GAMEOVER'; cancelAnimationFrame(animationId); 
            
            if(typeof gtag !== 'undefined') {
                gtag('event', 'game_over', { 
                    'score': score, 
                    'level': currentLevel 
                });
            }

            if (score > highScore) { highScore = score; localStorage.setItem('mestreClave_record', highScore); }
            document.getElementById('final-score').innerText = score; document.getElementById('final-level').innerText = currentLevel;
            document.getElementById('end-highscore').innerText = highScore; document.getElementById('start-highscore').innerText = highScore;
            
            const goFufuImg = document.getElementById('go-fufu-img');
            let imgToUse = "";

            if (currentLevel > 30) {
                // Vit√≥ria Suprema
                imgToUse = "../assets/fufu-comemorando-trof√©u-G-clave.png";
            } else if (currentLevel >= 13) {
                // N√≠veis Intermedi√°rios (13 a 30)
                const midImages = ["../assets/fufu-erro-encorajador.png", "../assets/fufu-erro-presente.png"];
                imgToUse = midImages[Math.floor(Math.random() * midImages.length)];
            } else {
                // N√≠veis Iniciais (at√© 12)
                const lowImages = ["../assets/fufu-erro-n√£o-desista.png", "../assets/fufu-erro-carinho.png", "../assets/fufu-erro-acontece.png"];
                imgToUse = lowImages[Math.floor(Math.random() * lowImages.length)];
            }
            
            goFufuImg.src = imgToUse;
            
            document.getElementById('game-over-screen').classList.remove('hidden'); 
        }
        function resetGame() { startGame(); }
        
        setTimeout(resize, 100);
    </script>
</body>
</html>