<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulado MSA | Issa Academy</title>
    
    <!-- Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-LF25LGNKEJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-LF25LGNKEJ');
    </script>

    <!-- Fonte e √çcones -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Music&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root { 
            /* Paleta Gamificada (Baseada na Issa Academy) */
            --brand-blue: #1a3c5a;
            --brand-gold: #c5a059;
            
            --duo-bg: #ffffff;
            --duo-surface: #f7f9fa;
            
            /* Cores de Fundo da Pergunta */
            --q-bg: #e5f6fd; 
            --q-border: #c3e3f7;
            
            /* Bot√µes e Intera√ß√£o (Juicy Colors) */
            --btn-blue: #1cb0f6; --btn-blue-shade: #1899d6;
            --btn-green: #58cc02; --btn-green-shade: #58a700;
            --btn-red: #ff4b4b;   --btn-red-shade: #ea2b2b;
            --btn-gold: #ffc800;  --btn-gold-shade: #e5b400;
            --btn-gray: #e5e5e5;  --btn-gray-shade: #cecece;
            
            --text-main: #4b4b4b;
            --text-light: #777;
            
            --radius: 16px; 
        }
        
        * { box-sizing: border-box; font-family: 'Nunito', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--duo-surface); 
            color: var(--text-main); 
            margin: 0; padding: 0; 
            min-height: 100vh; 
            display: flex; flex-direction: column; 
        }

        /* HEADER SIMPLES */
        .top-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 20px; max-width: 800px; margin: 0 auto; width: 100%;
        }
        .close-btn { font-size: 1.5rem; color: #e5e5e5; cursor: pointer; transition: color 0.2s; text-decoration: none;}
        .close-btn:hover { color: var(--text-main); }
        
        .progress-container { flex: 1; margin: 0 20px; background: #e5e5e5; height: 16px; border-radius: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--btn-gold); width: 0%; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); border-radius: 20px; position: relative; }
        .progress-highlight { position: absolute; top: 3px; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); border-radius: 20px; }

        /* Ajuste para imagens PNG do Fufu */
        .mascot-img-menu {
            width: 120px; height: auto; display: block; margin: 0 auto 10px;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.15));
        }

        /* CONTE√öDO DO QUIZ */
        .quiz-content {
            flex: 1; max-width: 600px; margin: 0 auto; width: 100%; padding: 0 20px 100px;
            display: flex; flex-direction: column; justify-content: flex-start;
            padding-top: 20px; /* Mais espa√ßo no topo pois removemos o mascote */
        }

        /* CART√ÉO DA PERGUNTA */
        .question-card {
            background-color: var(--q-bg);
            border: 2px solid var(--q-border);
            border-radius: var(--radius);
            padding: 25px 20px;
            margin-bottom: 25px;
            position: relative;
            box-shadow: 0 4px 0 rgba(0,0,0,0.05);
        }

        .q-number-badge {
            position: absolute; top: -15px; left: -10px;
            background-color: var(--brand-blue); color: white;
            font-weight: 800; font-size: 1.1rem;
            width: 40px; height: 40px; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2);
            transform: rotate(-5deg); border: 2px solid white;
        }

        h2.question-text {
            font-size: 1.25rem; color: var(--brand-blue); 
            margin: 0; line-height: 1.5;
            text-align: left; font-weight: 700;
        }

        .modal-title { 
            font-size: 2rem; 
            font-weight: 900; 
            color: var(--brand-gold); 
            margin: 10px 0; 
            letter-spacing: -1px; 
        }

        /* OP√á√ïES */
        .options-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
        @media (min-width: 600px) { .options-grid { grid-template-columns: 1fr 1fr; } }

        .duo-btn {
            background: white; 
            border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5;
            border-radius: 16px;
            padding: 12px 16px;
            font-size: 1rem; color: var(--text-main); font-weight: 700;
            cursor: pointer; position: relative;
            transition: all 0.1s; text-align: left;
            display: flex; align-items: center; gap: 15px;
        }
        .duo-btn:active { transform: translateY(4px); border-bottom-width: 0; margin-bottom: 4px; }
        .duo-btn:hover:not(:disabled) { background: #f7f9fa; border-color: #d1d5db; border-bottom-color: #d1d5db; }

        .option-letter {
            width: 32px; height: 32px; flex-shrink: 0;
            border: 2px solid #e5e5e5; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: 800; color: #afafaf; background: white; font-size: 0.9rem;
            transition: all 0.2s;
        }

        .duo-btn.selected { border-color: var(--btn-blue); border-bottom-color: var(--btn-blue-shade); background: #ddf4ff; color: var(--btn-blue-shade); }
        .duo-btn.selected .option-letter { background: var(--btn-blue); color: white; border-color: var(--btn-blue); }

        .duo-btn.correct { border-color: var(--btn-green); border-bottom-color: var(--btn-green-shade); background: #dfffc8; color: var(--btn-green-shade); }
        .duo-btn.correct .option-letter { background: var(--btn-green); color: white; border-color: var(--btn-green); }

        .duo-btn.wrong { border-color: var(--btn-red); border-bottom-color: var(--btn-red-shade); background: #ffdfe0; color: var(--btn-red-shade); }
        .duo-btn.wrong .option-letter { background: var(--btn-red); color: white; border-color: var(--btn-red); }

        /* CAIXA DE FEEDBACK SIMPLIFICADA */
        #feedback-box {
            margin-top: 20px; padding: 20px; border-radius: 16px;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: none;
            position: relative; 
            min-height: 80px; /* Garante altura para a imagem */
        }
        #feedback-box.correct { background: #d7ffb8; color: var(--btn-green-shade); border: 2px solid #b8f28b; }
        #feedback-box.wrong { background: #ffdfe0; color: var(--btn-red-shade); border: 2px solid #ffc1c1; }

        /* Fufu "Sticker" no Feedback */
        #feedback-fufu-img {
            position: absolute;
            top: -45px; /* Sobe para ficar na borda superior */
            right: 10px;
            width: 80px; /* Tamanho discreto mas vis√≠vel */
            height: auto;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
            z-index: 10;
            display: none; 
            animation: popIn 0.4s;
        }

        .feedback-header { font-weight: 800; font-size: 1.2rem; margin-bottom: 10px; display: flex; align-items: center; gap: 10px; }
        .feedback-body { 
            color: var(--text-main); font-size: 1rem; line-height: 1.5; 
            padding-right: 20px; /* Ajustado para 20px pois a imagem est√° no topo agora */
        }
        
        .ref-badge {
            display: inline-block; background: rgba(255,255,255,0.8);
            border: 1px solid rgba(0,0,0,0.1); padding: 6px 12px; border-radius: 12px;
            font-size: 0.85rem; font-weight: 700; color: var(--brand-blue);
            margin-top: 12px; text-transform: uppercase; letter-spacing: 0.5px;
            box-shadow: 0 2px 0 rgba(0,0,0,0.05);
        }

        /* FOOTER DE A√á√ÉO */
        .action-footer {
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: white; border-top: 2px solid #e5e5e5;
            padding: 15px 20px; display: flex; justify-content: flex-end; align-items: center;
            z-index: 100; transition: border-color 0.3s, background 0.3s;
        }
        .action-footer.correct { border-top-color: var(--btn-green); background: #f0ffe0; }
        .action-footer.wrong { border-top-color: var(--btn-red); background: #fff0f0; }

        .check-btn {
            background: var(--btn-green); color: white;
            border: none; border-bottom: 4px solid var(--btn-green-shade);
            border-radius: 12px; padding: 15px 30px;
            font-size: 1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px;
            cursor: pointer; width: 100%; transition: all 0.1s;
        }
        .check-btn:active { transform: translateY(4px); border-bottom-width: 0; }
        .check-btn.disabled { background: #e5e5e5; color: #afafaf; border-bottom-color: #cecece; pointer-events: none; }
        .check-btn.continue { background: var(--btn-blue); border-bottom-color: var(--btn-blue-shade); }
        .check-btn.continue-error { background: var(--btn-red); border-bottom-color: var(--btn-red-shade); }

        @media (min-width: 600px) { .check-btn { width: auto; min-width: 150px; } }

        /* TELA DE RESULTADO (UPGRADE) */
        .result-stats-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; margin-bottom: 20px;
        }
        .stat-box {
            background: #f7f9fa; border: 2px solid #e5e5e5; border-radius: 16px; padding: 15px;
            text-align: center;
        }
        .stat-label { font-size: 0.8rem; color: var(--text-light); text-transform: uppercase; font-weight: 700; display: block; }
        .stat-value { font-size: 1.5rem; font-weight: 800; color: var(--brand-blue); display: block; }

        .review-section {
            width: 100%; text-align: left; margin-top: 20px;
            max-height: 300px; overflow-y: auto;
            border-top: 2px solid #e5e5e5; padding-top: 20px;
        }
        .review-item {
            background: #fff5f5; border-left: 4px solid var(--btn-red);
            padding: 12px; border-radius: 8px; margin-bottom: 10px;
            font-size: 0.9rem;
        }
        .review-q { font-weight: 700; color: var(--text-main); margin-bottom: 5px; }
        .review-a { color: var(--btn-green-shade); font-weight: 600; }
        .review-ref { font-size: 0.75rem; color: #888; margin-top: 4px; display: block; }

        /* TELA MENU E SELE√á√ÉO DE FASES */
        #menu-screen { text-align: center; padding-top: 30px; max-width: 600px; margin: 0 auto; padding-bottom: 40px;}
        
        .period-grid {
            display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 15px;
        }
        @media (min-width: 480px) { .period-grid { grid-template-columns: 1fr 1fr; } }

        /* Card de Per√≠odo Compacto */
        .period-card {
            background: white; border: 2px solid #e5e5e5; border-bottom: 4px solid #e5e5e5;
            border-radius: 16px; padding: 15px; text-align: left;
            transition: all 0.1s; position: relative; overflow: hidden;
            display: flex; align-items: center; justify-content: space-between;
            min-height: auto; cursor: pointer;
        }
        .period-card:active { transform: translateY(4px); border-bottom-width: 2px; }
        
        /* Estado Ativo (Selecionado) */
        .period-card.active { 
            border-color: var(--btn-blue); 
            border-bottom-color: var(--btn-blue-shade); 
            background-color: #f0f9ff; 
        }
        .period-card.active .p-icon { color: var(--btn-blue); }
        
        /* Estado Bloqueado */
        .period-card.locked { 
            background: #f7f9fa; border-color: #e5e5e5; cursor: not-allowed; opacity: 0.7; 
            pointer-events: none;
        }
        .period-card.locked .p-icon { color: #ccc; }

        .p-content { flex: 1; }
        .p-title { font-weight: 800; font-size: 1rem; color: var(--text-main); margin: 0; }
        .p-subtitle { font-size: 0.8rem; color: var(--text-light); margin: 0; }
        .p-icon { font-size: 1.2rem; margin-left: 10px; }

        /* Op√ß√£o Selecionar Todos */
        .select-all-container {
            display: flex; align-items: center; justify-content: flex-end;
            margin-bottom: 10px; font-weight: 700; font-size: 0.9rem; color: var(--brand-blue);
            cursor: pointer;
        }
        .select-all-container input { margin-right: 8px; transform: scale(1.2); cursor: pointer; }

        /* BOT√ïES GRANDES PADRONIZADOS */
        .btn-big {
            display: block; width: 100%;
            border: none; border-radius: 16px; padding: 18px;
            font-size: 1.2rem; font-weight: 800; text-transform: uppercase;
            cursor: pointer; margin-top: 15px; text-decoration: none; text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            transition: transform 0.1s;
        }
        .btn-big:active { transform: translateY(4px); border-bottom-width: 0 !important; margin-top: 19px; margin-bottom: -4px; box-shadow: none; }
        .btn-big:disabled, .btn-big.disabled { background: #e5e5e5; color: #afafaf; border-bottom: 4px solid #cecece; pointer-events: none; box-shadow: none; }

        /* Variantes de Cor */
        .btn-green { background: var(--btn-green); color: white; border-bottom: 4px solid var(--btn-green-shade); }
        .btn-red { background: var(--btn-red); color: white; border-bottom: 4px solid var(--btn-red-shade); }
        .btn-gray { background: var(--btn-gray); color: var(--text-main); border-bottom: 4px solid var(--btn-gray-shade); }

        .hidden { display: none !important; }
        .time-sig { background: #eee; padding: 2px 5px; border-radius: 4px; display: inline-block; vertical-align: middle; line-height: 0.9; font-family: 'Noto Music', serif; text-align: center; }
        .time-sig span { display: block; font-size: 0.8em; }

        /* Classe para imagem de resultado grande */
        .mascot-img-result {
            width: 140px; height: auto; display: block; margin: 0 auto 20px;
            animation: float 3s infinite ease-in-out;
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.2));
        }

        @keyframes popIn { 0% { transform: scale(0); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideUp { 0% { transform: translateY(10px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0); } }
    </style>
</head>
<body>

    <!-- MENU INICIAL (SELE√á√ÉO DE FASES) -->
    <div id="menu-screen">
        <div class="mascot-area" style="justify-content: center; margin-bottom: 0;">
            <img src="../assets/fufu-capa-simulado.png" class="mascot-img-menu" alt="Fufu Simulado">
        </div>
        
        <!-- T√çTULO -->
        <h1 class="modal-title">Simulado MSA</h1>
        
        <!-- SELE√á√ÉO DE CONTE√öDO -->
        <div style="text-align: center; margin-bottom: 15px;">
            <p style="color: var(--text-light); margin: 0 0 5px 0; font-weight: 700;">Selecione os Per√≠odos:</p>
            <div class="select-all-container" onclick="toggleSelectAll()" style="justify-content: center;">
                <input type="checkbox" id="select-all-check" checked> Todos
            </div>
        </div>
        
        <div class="period-grid">
            <!-- Per√≠odo 1 (Selecion√°vel) - ATIVO POR PADR√ÉO -->
            <div id="card-p1" class="period-card active" onclick="selectPeriod(1)">
                <div class="p-content">
                    <h3 class="p-title">Per√≠odo 1</h3>
                    <p class="p-subtitle">Fases 1, 2 e 3</p>
                </div>
                <i class="fas fa-flag p-icon"></i>
            </div>

            <!-- Per√≠odo 2 (Selecion√°vel) - DESBLOQUEADO -->
            <div id="card-p2" class="period-card" onclick="selectPeriod(2)">
                <div class="p-content">
                    <h3 class="p-title">Per√≠odo 2</h3>
                    <p class="p-subtitle">Fases 4 e 5</p>
                </div>
                <i class="fas fa-flag p-icon"></i>
            </div>

            <!-- Per√≠odo 3 (Bloqueado) -->
            <div class="period-card locked">
                <div class="p-content">
                    <h3 class="p-title">Per√≠odo 3</h3>
                    <p class="p-subtitle">Em Breve</p>
                </div>
                <i class="fas fa-lock p-icon"></i>
            </div>

            <!-- Per√≠odo 4 (Bloqueado) -->
            <div class="period-card locked">
                <div class="p-content">
                    <h3 class="p-title">Per√≠odo 4</h3>
                    <p class="p-subtitle">Em Breve</p>
                </div>
                <i class="fas fa-lock p-icon"></i>
            </div>
        </div>

        <!-- Bot√£o COME√áAR -->
        <button id="btn-start-quiz" class="btn-big btn-green" onclick="prepareAndStart()">COME√áAR</button>
        <a href="../index.html" class="btn-big btn-gray">VOLTAR</a>
    </div>

    <!-- TELA DO QUIZ -->
    <div id="quiz-screen" class="hidden">
        
        <div class="top-bar">
            <!-- Bot√£o de Sair -->
            <a href="javascript:void(0)" onclick="confirmExit()" class="close-btn"><i class="fas fa-times"></i></a>
            <div class="progress-container"><div class="progress-fill" id="progress-bar"><div class="progress-highlight"></div></div></div>
            <!-- HUD -->
            <div style="color: var(--brand-blue); font-weight: 800; font-size: 1.1rem;">
                <span id="q-counter-current">01</span>/<span id="q-counter-total">20</span>
            </div>
        </div>

        <!-- REMOVIDO MASCOTE AREA SUPERIOR -->

        <div class="quiz-content">
            <!-- PERGUNTA -->
            <div class="question-card">
                <div id="q-number" class="q-number-badge">1</div>
                <h2 id="q-text" class="question-text">Carregando pergunta...</h2>
            </div>

            <div id="options-container" class="options-grid"></div>
            
            <!-- FEEDBACK BOX -->
            <div id="feedback-box">
                <!-- MINI FUFU (Aparece aqui) -->
                <img id="feedback-fufu-img" src="" alt="Fufu Rea√ß√£o">
                
                <div class="feedback-header" id="feedback-title"></div>
                <div class="feedback-body" id="feedback-content"></div>
                <div id="feedback-ref-container"></div>
            </div>
        </div>

        <!-- FOOTER -->
        <div id="footer-area" class="action-footer">
            <button id="check-btn" class="check-btn disabled" onclick="checkOrNext()">VERIFICAR</button>
        </div>

    </div>

    <!-- TELA DE RESULTADO -->
    <div id="result-screen" class="hidden" style="text-align: center; padding: 40px 20px;">
        <!-- Imagem de Resultado -->
        <img id="fufu-result-img" src="" class="mascot-img-result" alt="Resultado Fufu">
        
        <h1 id="result-title" style="color: var(--brand-blue); margin-bottom: 5px;">Treino Conclu√≠do!</h1>
        <p id="result-msg" style="color: var(--text-light); margin-bottom: 20px;">Veja como voc√™ se saiu</p>
        
        <div class="big-card" style="background: white; border-radius: 20px; border: 2px solid #e5e5e5; padding: 30px; margin: 20px auto; max-width: 400px; box-shadow: 0 10px 0 #e5e5e5;">
            <div class="result-stats-container">
                <div class="stat-box">
                    <span class="stat-label">Precis√£o</span>
                    <span class="stat-value" id="final-percent" style="color: var(--btn-green);">0%</span>
                </div>
                <div class="stat-box">
                    <span class="stat-label">Tempo</span>
                    <span class="stat-value" id="final-time" style="color: var(--btn-gold-shade);">00:00</span>
                </div>
            </div>

            <div id="review-container" class="hidden">
                <h4 style="text-align: left; color: var(--btn-red); margin-bottom: 10px;"> <i class="fas fa-exclamation-circle"></i> O que precisa melhorar:</h4>
                <div id="review-list" class="review-section"></div>
            </div>

            <button class="btn-big btn-green" onclick="location.reload()">NOVO SIMULADO</button>
            <a href="../index.html" class="btn-big btn-red">SAIR</a>
        </div>
    </div>

    <script>
        // === CONFIGURA√á√ÉO DO FUFU AMOROSO (v2.0 - Imagens PNG) ===
        const FUFU_STATES = {
            NEUTRAL: { 
                type: 'image', 
                content: '../assets/fufu-neutro.png' 
            }, 
            HAPPY: { 
                type: 'image', 
                content: [
                    '../assets/fufu-acerto-piscando.png',
                    '../assets/fufu-acerto-palmas.png',
                    '../assets/fufu-acerto-joinha.png',
                    '../assets/fufu-acerto-festa.png',
                    '../assets/fufu-acerto-esperto.png',
                    '../assets/fufu-acerto-aplausos.png'
                ] 
            },
            SAD: { 
                type: 'image', 
                content: [
                    '../assets/fufu-erro-n√£o-desista.png',
                    '../assets/fufu-erro-carinho.png',
                    '../assets/fufu-erro-acontece.png'
                ] 
            }
        };

        // REMOVIDO: FUFU_PHRASES (Feedback de texto removido)

        window.bancoQuestoes = []; 
        let currentQuestions = [];
        let currentIndex = 0;
        let score = 0;
        let selectedOption = null; 
        let currentQuestionData = null;
        let isAnswerChecked = false;
        
        let quizStartTime;
        let wrongAnswers = [];

        // Inicializa√ß√£o com Per√≠odos Dispon√≠veis (1 e 2)
        // Por padr√£o, o Per√≠odo 1 vem marcado (selectedPeriods)
        let selectedPeriods = new Set([1]);
        const availablePeriods = [1, 2]; 

        function enterFullScreen() {
            const el = document.documentElement;
            if (el.requestFullscreen) el.requestFullscreen().catch(err => console.log(err));
            else if (el.webkitRequestFullscreen) el.webkitRequestFullscreen(); 
            else if (el.msRequestFullscreen) el.msRequestFullscreen(); 
        }

        function exitFullScreen() {
            if (document.exitFullscreen) document.exitFullscreen().catch(err => console.log(err));
            else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
        }

        function confirmExit() {
            if (confirm("Tem certeza? Se sair agora, perder√° o progresso do simulado.")) {
                exitFullScreen();
                location.reload();
            }
        }

        // REMOVIDO: setFufu (N√£o √© mais usado no topo da quest√£o)

        function formatMusicText(text) {
            if(!text) return "";
            return text.replace(/(\d{1,2})\/(\d{1,2})/g, function(match, num, den) {
                return `<span class="time-sig"><span>${num}</span><span>${den}</span></span>`;
            });
        }

        // Mapeamento dos Arquivos de Quest√µes por Per√≠odo
        const periodMap = { 
            1: ['q_f01.js', 'q_f02.js', 'q_f03.js'],
            2: ['q_f04.js', 'q_f05.js']
        };

        function selectPeriod(p) {
            if (!availablePeriods.includes(p)) return;

            const card = document.getElementById(`card-p${p}`);
            
            if (selectedPeriods.has(p)) {
                selectedPeriods.delete(p);
                card.classList.remove('active');
            } else {
                selectedPeriods.add(p);
                card.classList.add('active');
            }
            updateStartButton();
            updateSelectAllCheckbox();
        }

        function toggleSelectAll() {
            const checkBox = document.getElementById('select-all-check');
            const targetState = !checkBox.checked; // Clicou no container, inverte estado atual
            checkBox.checked = targetState;

            availablePeriods.forEach(p => {
                const card = document.getElementById(`card-p${p}`);
                if (targetState) {
                    selectedPeriods.add(p);
                    card.classList.add('active');
                } else {
                    selectedPeriods.delete(p);
                    card.classList.remove('active');
                }
            });
            updateStartButton();
        }

        function updateSelectAllCheckbox() {
            const checkBox = document.getElementById('select-all-check');
            const allSelected = availablePeriods.every(p => selectedPeriods.has(p));
            checkBox.checked = allSelected && availablePeriods.length > 0;
        }

        function updateStartButton() {
            const btn = document.getElementById('btn-start-quiz');
            if (selectedPeriods.size > 0) {
                btn.classList.remove('disabled');
                btn.disabled = false;
            } else {
                btn.classList.add('disabled');
                btn.disabled = true;
            }
        }

        async function loadScripts(scripts) {
            const promises = scripts.map(src => new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = () => { console.warn('Falha: ' + src); resolve(); };
                document.body.appendChild(s);
            }));
            return Promise.all(promises);
        }

        async function prepareAndStart() {
            if (selectedPeriods.size === 0) return;

            enterFullScreen();

            const btn = document.getElementById('btn-start-quiz');
            const originalText = btn.innerText;
            btn.innerText = "Carregando...";
            btn.disabled = true;

            let allScripts = [];
            selectedPeriods.forEach(p => {
                if (periodMap[p]) allScripts = allScripts.concat(periodMap[p]);
            });

            await loadScripts(allScripts);
            
            if (!window.bancoQuestoes || window.bancoQuestoes.length === 0) {
                alert("Erro ao carregar quest√µes. Verifique se os arquivos est√£o na pasta.");
                btn.innerText = originalText;
                btn.disabled = false;
                return;
            }
            
            currentQuestions = window.bancoQuestoes
                .filter(q => q.ativo !== false)
                .sort(() => 0.5 - Math.random())
                .slice(0, 20); 
            
            currentIndex = 0;
            score = 0;
            wrongAnswers = [];
            quizStartTime = new Date(); 
            
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            renderQuestion();
        }

        function renderQuestion() {
            isAnswerChecked = false;
            selectedOption = null;
            currentQuestionData = currentQuestions[currentIndex];
            
            document.getElementById('footer-area').className = 'action-footer';
            document.getElementById('feedback-box').style.display = 'none';
            document.getElementById('feedback-box').className = ''; 
            
            // Esconde o mini-fufu at√© haver feedback
            document.getElementById('feedback-fufu-img').style.display = 'none';

            const btn = document.getElementById('check-btn');
            btn.innerText = "VERIFICAR";
            btn.className = "check-btn disabled";
            btn.onclick = checkAnswer;

            const pct = (currentIndex / currentQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = pct + '%';

            // REMOVIDO: setFufu(NEUTRAL)

            document.getElementById('q-number').innerText = currentIndex + 1;
            document.getElementById('q-text').innerHTML = formatMusicText(currentQuestionData.pergunta);
            
            document.getElementById('q-counter-current').innerText = (currentIndex + 1).toString().padStart(2, '0');
            document.getElementById('q-counter-total').innerText = currentQuestions.length;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            const opts = [...currentQuestionData.opcoes].sort(() => 0.5 - Math.random());
            currentQuestionData.shuffledOpts = opts; 

            const letters = ['A', 'B', 'C', 'D', 'E'];

            opts.forEach((opt, idx) => {
                const btnEl = document.createElement('button');
                btnEl.className = 'duo-btn';
                const letter = letters[idx] || '?';
                btnEl.innerHTML = `<span class="option-letter">${letter}</span><span>${formatMusicText(opt.texto)}</span>`;
                btnEl.onclick = () => selectOption(btnEl, opt);
                container.appendChild(btnEl);
            });
            
            window.scrollTo(0, 0);
        }

        function selectOption(btnEl, optData) {
            if (isAnswerChecked) return;

            document.querySelectorAll('.duo-btn').forEach(b => b.classList.remove('selected'));
            
            btnEl.classList.add('selected');
            selectedOption = { el: btnEl, data: optData };
            
            const checkBtn = document.getElementById('check-btn');
            checkBtn.classList.remove('disabled');
        }

        function checkAnswer() {
            if (!selectedOption || isAnswerChecked) return;
            isAnswerChecked = true;

            const isCorrect = selectedOption.data.correta === true;
            const footer = document.getElementById('footer-area');
            const checkBtn = document.getElementById('check-btn');
            
            const feedbackBox = document.getElementById('feedback-box');
            const feedbackTitle = document.getElementById('feedback-title');
            const feedbackContent = document.getElementById('feedback-content');
            const feedbackRef = document.getElementById('feedback-ref-container');
            const feedbackFufuImg = document.getElementById('feedback-fufu-img');

            let refBadgeHTML = "";
            if(currentQuestionData.referencia) {
                const ref = currentQuestionData.referencia;
                const itemText = ref.item ? ` ‚Ä¢ ${ref.item}` : "";
                const refText = `üìñ ${ref.livro} ‚Ä¢ Fase ${ref.fase} ‚Ä¢ P√°g. ${ref.pagina}${itemText}`;
                refBadgeHTML = `<div class="ref-badge">${refText}</div>`;
            }

            if (isCorrect) {
                score++;
                selectedOption.el.classList.add('correct');
                footer.classList.add('correct');
                
                feedbackBox.className = 'correct';
                feedbackBox.style.display = 'block';
                feedbackTitle.innerHTML = '<i class="fas fa-check-circle"></i> Correto!';
                feedbackContent.innerHTML = formatMusicText(selectedOption.data.feedback || "Resposta exata!");
                feedbackRef.innerHTML = refBadgeHTML;

                // REMOVIDO: setFufu(HAPPY)
                
                // Configura Mini-Fufu Feliz
                const happySrc = FUFU_STATES.HAPPY.content;
                feedbackFufuImg.src = Array.isArray(happySrc) ? happySrc[Math.floor(Math.random() * happySrc.length)] : happySrc;
                feedbackFufuImg.style.display = 'block';

                checkBtn.className = "check-btn continue";
            } else {
                selectedOption.el.classList.add('wrong');
                
                const correctOpt = currentQuestionData.opcoes.find(o => o.correta);
                wrongAnswers.push({
                    question: currentQuestionData.pergunta,
                    correctAnswer: correctOpt.texto,
                    ref: refBadgeHTML
                });

                document.querySelectorAll('.duo-btn').forEach((b, idx) => {
                    if(currentQuestionData.shuffledOpts[idx].correta) {
                        b.classList.add('correct'); 
                    }
                });
                
                footer.classList.add('wrong'); 
                feedbackBox.className = 'wrong';
                feedbackBox.style.display = 'block';
                feedbackTitle.innerHTML = '<i class="fas fa-times-circle"></i> Incorreto...';
                
                const wrongExplanation = selectedOption.data.feedback ? 
                    `<div style="margin-bottom:10px; font-style:italic;">"${formatMusicText(selectedOption.data.feedback)}"</div>` : "";
                
                feedbackContent.innerHTML = `
                    ${wrongExplanation}
                    <div style="margin-top:10px; border-top:1px solid rgba(0,0,0,0.1); padding-top:10px;">
                        <strong>Solu√ß√£o:</strong> ${formatMusicText(correctOpt.texto)}
                    </div>
                `;
                feedbackRef.innerHTML = refBadgeHTML;

                // REMOVIDO: setFufu(SAD)
                
                // Configura Mini-Fufu Triste
                const sadSrc = FUFU_STATES.SAD.content;
                feedbackFufuImg.src = Array.isArray(sadSrc) ? sadSrc[Math.floor(Math.random() * sadSrc.length)] : sadSrc;
                feedbackFufuImg.style.display = 'block';

                checkBtn.className = "check-btn continue-error";
            }

            checkBtn.innerText = "CONTINUAR";
            checkBtn.onclick = nextQuestion;
            
            setTimeout(() => {
                feedbackBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex < currentQuestions.length) {
                renderQuestion();
            } else {
                showResults();
            }
        }

        function showResults() {
            document.getElementById('quiz-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            
            const timeSpent = Math.floor((new Date() - quizStartTime) / 1000);
            const minutes = Math.floor(timeSpent / 60);
            const seconds = timeSpent % 60;
            const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            document.getElementById('final-time').innerText = timeString;

            const percentage = Math.round((score / currentQuestions.length) * 100);
            document.getElementById('final-percent').innerText = percentage + "%";

            const fufuImg = document.getElementById('fufu-result-img');
            const resultMsg = document.getElementById('result-msg');
            
            let finalImage = "";

            if (percentage === 100) {
                finalImage = "../assets/fufu-comemorando-trof√©u-gabarito.png";
                resultMsg.innerText = "Perfeito! Voc√™ √© um virtuoso!";
            } else if (percentage >= 80) {
                finalImage = "../assets/fufu-comemorando-trof√©u-G-clave.png";
                resultMsg.innerText = "Muito bom! Quase l√°.";
            } else if (percentage >= 50) {
                const midImages = ["../assets/fufu-erro-presente.png", "../assets/fufu-erro-encorajador.png"];
                finalImage = midImages[Math.floor(Math.random() * midImages.length)];
                resultMsg.innerText = "Bom esfor√ßo! Continue estudando que vai dar certo.";
            } else {
                const lowImages = ["../assets/fufu-erro-n√£o-desista.png", "../assets/fufu-erro-carinho.png", "../assets/fufu-erro-acontece.png"];
                finalImage = lowImages[Math.floor(Math.random() * lowImages.length)];
                resultMsg.innerText = "O in√≠cio √© trabalhoso mesmo. N√£o desista!";
            }

            fufuImg.src = finalImage;

            const reviewContainer = document.getElementById('review-container');
            const reviewList = document.getElementById('review-list');
            
            if (wrongAnswers.length > 0) {
                reviewContainer.classList.remove('hidden');
                reviewList.innerHTML = wrongAnswers.map(item => `
                    <div class="review-item">
                        <div class="review-q">${formatMusicText(item.question)}</div>
                        <div class="review-a"><i class="fas fa-check"></i> ${formatMusicText(item.correctAnswer)}</div>
                        <div class="review-ref">${item.ref}</div>
                    </div>
                `).join('');
            } else {
                reviewContainer.classList.add('hidden');
            }
        }
    </script>
</body>
</html>